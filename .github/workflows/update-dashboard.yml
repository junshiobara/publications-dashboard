name: Update Publications Dashboard

on:
  schedule:
    # æ¯æ—¥ãƒ‘ãƒªæ™‚é–“7:00ï¼ˆUTC 5:00ï¼‰ã«è‡ªå‹•å®Ÿè¡Œ
    - cron: '0 5 * * *'
  workflow_dispatch:

jobs:
  crawl-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 30åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆæ©Ÿé–¢æ•°ãŒå¤šã„ãŸã‚ï¼‰
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 pytz lxml feedparser
        
    - name: Run comprehensive crawler
      run: |
        python3 -c "
        import requests
        import json
        import re
        from datetime import datetime
        from bs4 import BeautifulSoup
        import pytz
        import time
        import sys
        import feedparser
        
        # ãƒ‘ãƒªæ™‚é–“è¨­å®š
        paris_tz = pytz.timezone('Europe/Paris')
        current_time = datetime.now(paris_tz).strftime('%Y-%m-%d %H:%M:%S (ãƒ‘ãƒªæ™‚é–“)')
        
        print(f'ğŸš€ ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°é–‹å§‹: {current_time}')
        
        # å®‰å…¨ãªã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°è¨­å®š
        session = requests.Session()
        session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        })
        
        # Excelãƒ•ã‚¡ã‚¤ãƒ«ã«åŸºã¥ãå®Œå…¨ãªæ©Ÿé–¢ãƒªã‚¹ãƒˆ
        institutions = [
            # ã‚¤ã‚¿ãƒªã‚¢ä¸­å¤®éŠ€è¡Œ
            {
                'name': 'Banca d\'Italia',
                'publications': [
                    {
                        'title': 'Financial Stability Report',
                        'url': 'https://www.bancaditalia.it/pubblicazioni/rapporto-stabilita/',
                        'search_terms': ['financial stability', 'rapporto stabilitÃ ', 'stability report']
                    },
                    {
                        'title': 'Macroeconomic Projections',
                        'url': 'https://www.bancaditalia.it/pubblicazioni/bollettino-economico/',
                        'search_terms': ['macroeconomic projections', 'proiezioni macroeconomiche', 'bollettino economico']
                    }
                ]
            },
            # ã‚¹ãƒšã‚¤ãƒ³ä¸­å¤®éŠ€è¡Œ
            {
                'name': 'Banco de EspaÃ±a',
                'publications': [
                    {
                        'title': 'Financial Stability Report',
                        'url': 'https://www.bde.es/bde/en/secciones/informes/Publicaciones_an/Informe_de_Estab/',
                        'search_terms': ['financial stability', 'estabilidad financiera', 'stability report']
                    },
                    {
                        'title': 'Macroeconomic Projections',
                        'url': 'https://www.bde.es/bde/en/secciones/informes/Publicaciones_an/Boletin_Economico/',
                        'search_terms': ['macroeconomic projections', 'proyecciones macroeconÃ³micas']
                    }
                ]
            },
            # OECD
            {
                'name': 'OECD',
                'publications': [
                    {
                        'title': 'Economic Outlook',
                        'url': 'https://www.oecd.org/en/publications/oecd-economic-outlook-16097408.html',
                        'search_terms': ['economic outlook', 'interim economic outlook']
                    },
                    {
                        'title': 'Interim Economic Outlook',
                        'url': 'https://www.oecd.org/en/publications/',
                        'search_terms': ['interim economic outlook', 'economic outlook']
                    }
                ]
            },
            # æ¬§å·å§”å“¡ä¼š
            {
                'name': 'European Commission',
                'publications': [
                    {
                        'title': 'Economic Forecast',
                        'url': 'https://economy-finance.ec.europa.eu/economic-research-and-databases/economic-databases/economic-forecast_en',
                        'search_terms': ['economic forecast', 'spring forecast', 'autumn forecast']
                    },
                    {
                        'title': 'European Semester Spring Package',
                        'url': 'https://commission.europa.eu/business-economy-euro/economic-and-fiscal-policy-coordination/european-semester_en',
                        'search_terms': ['european semester', 'spring package', 'country specific recommendations']
                    },
                    {
                        'title': 'European Semester Autumn Package',
                        'url': 'https://commission.europa.eu/business-economy-euro/economic-and-fiscal-policy-coordination/european-semester_en',
                        'search_terms': ['european semester', 'autumn package', 'annual growth survey']
                    },
                    {
                        'title': 'Guidance on Fiscal Policy',
                        'url': 'https://economy-finance.ec.europa.eu/economic-and-fiscal-governance_en',
                        'search_terms': ['fiscal policy', 'fiscal guidance', 'stability and growth pact']
                    }
                ]
            },
            # ãƒ•ãƒ©ãƒ³ã‚¹ä¸­å¤®éŠ€è¡Œ
            {
                'name': 'Banque de France',
                'publications': [
                    {
                        'title': 'Financial Stability Report',
                        'url': 'https://www.banque-france.fr/en/publications-and-statistics/publications/financial-stability-report',
                        'search_terms': ['financial stability', 'rapport stabilitÃ© financiÃ¨re']
                    },
                    {
                        'title': 'Macroeconomic Projections',
                        'url': 'https://www.banque-france.fr/en/publications-and-statistics/publications/macroeconomic-projections',
                        'search_terms': ['macroeconomic projections', 'projections macroÃ©conomiques']
                    }
                ]
            },
            # EBA
            {
                'name': 'EBA',
                'publications': [
                    {
                        'title': 'ESEP',
                        'url': 'https://www.eba.europa.eu/risk-analysis-and-data/european-supervisory-examination-programme-esep',
                        'search_terms': ['esep', 'european supervisory examination programme', 'supervisory examination']
                    },
                    {
                        'title': 'EU-wide Stress Test',
                        'url': 'https://www.eba.europa.eu/risk-analysis-and-data/eu-wide-stress-testing',
                        'search_terms': ['stress test', 'eu-wide stress test', 'banking stress test']
                    }
                ]
            },
            # IMF
            {
                'name': 'IMF',
                'publications': [
                    {
                        'title': 'World Economic Outlook',
                        'url': 'https://www.imf.org/en/Publications/WEO',
                        'search_terms': ['world economic outlook', 'weo', 'global growth']
                    },
                    {
                        'title': 'Global Financial Stability Report',
                        'url': 'https://www.imf.org/en/Publications/GFSR',
                        'search_terms': ['global financial stability', 'gfsr', 'financial stability']
                    },
                    {
                        'title': 'Fiscal Monitor',
                        'url': 'https://www.imf.org/en/Publications/FM',
                        'search_terms': ['fiscal monitor', 'public finances', 'fiscal policy']
                    }
                ]
            },
            # IEA
            {
                'name': 'IEA',
                'publications': [
                    {
                        'title': 'World Energy Outlook',
                        'url': 'https://www.iea.org/reports/world-energy-outlook-2024',
                        'search_terms': ['world energy outlook', 'weo', 'energy outlook']
                    },
                    {
                        'title': 'Global Energy Review',
                        'url': 'https://www.iea.org/reports/global-energy-review-2025',
                        'search_terms': ['global energy review', 'energy review', 'energy data']
                    }
                ]
            },
            # æ ¼ä»˜ã‘æ©Ÿé–¢ - Moody's
            {
                'name': 'Moody\'s',
                'publications': [
                    {
                        'title': 'Sovereign Ratings (Portugal, Italy, Spain, France)',
                        'url': 'https://www.moodys.com/research-and-ratings/market-segment/sovereign-supranational/-/005005/005005/-/-1/0/-/0/-/-/-/-/-/-/en/global/rra',
                        'search_terms': ['sovereign rating', 'portugal', 'italy', 'spain', 'france', 'rating action']
                    }
                ]
            },
            # æ ¼ä»˜ã‘æ©Ÿé–¢ - S&P
            {
                'name': 'S&P',
                'publications': [
                    {
                        'title': 'Sovereign Ratings (Portugal, Italy, Spain, France)',
                        'url': 'https://www.spglobal.com/ratings/en/research-insights/topics/sovereigns',
                        'search_terms': ['sovereign rating', 'portugal', 'italy', 'spain', 'france', 'rating action']
                    }
                ]
            },
            # æ ¼ä»˜ã‘æ©Ÿé–¢ - Fitch
            {
                'name': 'Fitch',
                'publications': [
                    {
                        'title': 'Sovereign Ratings (Portugal, Italy, Spain, France)',
                        'url': 'https://www.fitchratings.com/research/sovereigns',
                        'search_terms': ['sovereign rating', 'portugal', 'italy', 'spain', 'france', 'rating action']
                    }
                ]
            }
        ]
        
        results = []
        success_count = 0
        total_pubs = sum(len(inst['publications']) for inst in institutions)
        
        print(f'ğŸ“Š åˆè¨ˆ {len(institutions)} æ©Ÿé–¢ã€{total_pubs} å…¬è¡¨ç‰©ã‚’ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã—ã¾ã™')
        
        for inst in institutions:
            print(f'\\nğŸ›ï¸  {inst[\"name\"]} ã‚’ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°ä¸­...')
            
            for pub in inst['publications']:
                try:
                    print(f'  ğŸ“„ {pub[\"title\"]} ã‚’ç¢ºèªä¸­...')
                    
                    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ããƒªã‚¯ã‚¨ã‚¹ãƒˆ
                    response = session.get(pub['url'], timeout=15)
                    
                    if response.status_code == 200:
                        soup = BeautifulSoup(response.content, 'html.parser')
                        
                        # æ¤œç´¢èªã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç¢ºèª
                        found_content = False
                        found_terms = []
                        for term in pub['search_terms']:
                            if term.lower() in response.text.lower():
                                found_content = True
                                found_terms.append(term)
                        
                        # æœ€æ–°ã®æ—¥ä»˜ã‚’æ¢ã™
                        date_pattern = r'20[2-9][0-9][-/][0-1][0-9][-/][0-3][0-9]'
                        dates = re.findall(date_pattern, response.text)
                        latest_date = max(dates) if dates else None
                        
                        results.append({
                            'institution': inst['name'],
                            'publication': pub['title'],
                            'url': pub['url'],
                            'status': 'âœ… æ¥ç¶šæˆåŠŸ' if found_content else 'âš ï¸ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æœªç¢ºèª',
                            'found_terms': found_terms,
                            'latest_date_found': latest_date,
                            'crawled_at': current_time
                        })
                        
                        if found_content:
                            success_count += 1
                            print(f'    âœ… æˆåŠŸ (æ¤œå‡ºèª: {found_terms[:2]})')
                        else:
                            print(f'    âš ï¸  æ¥ç¶šã¯ã§ããŸãŒå†…å®¹æœªç¢ºèª')
                    else:
                        results.append({
                            'institution': inst['name'],
                            'publication': pub['title'],
                            'url': pub['url'],
                            'status': f'âŒ HTTP {response.status_code}',
                            'crawled_at': current_time
                        })
                        print(f'    âŒ å¤±æ•—: HTTP {response.status_code}')
                    
                    # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼šå„ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã«2ç§’å¾…æ©Ÿ
                    time.sleep(2)
                    
                except Exception as e:
                    results.append({
                        'institution': inst['name'],
                        'publication': pub['title'],
                        'url': pub['url'],
                        'status': f'âŒ ã‚¨ãƒ©ãƒ¼: {str(e)[:100]}',
                        'crawled_at': current_time
                    })
                    print(f'    âŒ ã‚¨ãƒ©ãƒ¼: {e}')
                    continue
        
        # çµæœä¿å­˜
        final_results = {
            'last_crawl': current_time,
            'total_institutions': len(institutions),
            'total_publications': total_pubs,
            'successful_crawls': success_count,
            'success_rate': f'{(success_count/total_pubs)*100:.1f}%',
            'results': results
        }
        
        with open('crawl_results.json', 'w', encoding='utf-8') as f:
            json.dump(final_results, f, ensure_ascii=False, indent=2)
        
        print(f'\\nğŸ“Š ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°å®Œäº†: {success_count}/{total_pubs} æˆåŠŸ ({(success_count/total_pubs)*100:.1f}%)')
        print(f'ğŸ“ çµæœã¯ crawl_results.json ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ')
        "
        
    - name: Update HTML dashboard
      run: |
        # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’æ›´æ–°
        PARIS_TIME=$(TZ='Europe/Paris' date '+%Y-%m-%d %H:%M:%S (ãƒ‘ãƒªæ™‚é–“)')
        
        if [ -f "index.html" ]; then
          # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‚’ç½®æ›
          sed -i "s/{{LAST_UPDATE_TIME}}/$PARIS_TIME/g" index.html
          
          # æ—¢å­˜ã®æ›´æ–°æ™‚åˆ»ã‚‚ç½®æ›
          sed -i "s/æœ€çµ‚æ›´æ–°: [^<]*/æœ€çµ‚æ›´æ–°: $PARIS_TIME/g" index.html
          
          echo "âœ… HTMLãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°å®Œäº†: $PARIS_TIME"
        else
          echo "âŒ index.html ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
    - name: Generate detailed report
      run: |
        # ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°çµæœã‹ã‚‰è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        python3 -c "
        import json
        from datetime import datetime
        
        try:
            with open('crawl_results.json', 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            print('\\nğŸ“Š è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ')
            print(f'æœ€çµ‚å®Ÿè¡Œ: {data[\"last_crawl\"]}')
            print(f'æˆåŠŸç‡: {data.get(\"success_rate\", \"N/A\")}')
            print(f'ç·æ©Ÿé–¢æ•°: {data[\"total_institutions\"]}')
            print(f'ç·å…¬è¡¨ç‰©æ•°: {data[\"total_publications\"]}')
            print(f'æˆåŠŸæ•°: {data[\"successful_crawls\"]}')
            
            print('\\nğŸ“‹ æ©Ÿé–¢åˆ¥çµæœ:')
            institutions = {}
            for result in data['results']:
                inst = result['institution']
                if inst not in institutions:
                    institutions[inst] = {'success': 0, 'total': 0}
                institutions[inst]['total'] += 1
                if 'âœ…' in result['status']:
                    institutions[inst]['success'] += 1
            
            for inst, stats in institutions.items():
                rate = (stats['success']/stats['total'])*100
                print(f'  {inst}: {stats[\"success\"]}/{stats[\"total\"]} ({rate:.0f}%)')
            
        except Exception as e:
            print(f'ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}')
        "
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [ -n "$(git status --porcelain)" ]; then
          git add index.html crawl_results.json
          git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°: $(TZ='Europe/Paris' date '+%Y-%m-%d %H:%M') | $(cat crawl_results.json | jq -r '.success_rate // \"N/A\"') æˆåŠŸç‡"
          git push
          echo "âœ… å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
        else
          echo "â„¹ï¸ å¤‰æ›´ãŒãªã„ãŸã‚ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
        fi
